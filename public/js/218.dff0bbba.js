"use strict";(globalThis["webpackChunkfrontend"]=globalThis["webpackChunkfrontend"]||[]).push([[218],{2218:(e,t,n)=>{n.r(t),n.d(t,{default:()=>ke});var a=n(1347),i=n(7763),l=n(4187),s=n(5679);const o=(0,s.nY)("user",(()=>{let e={},t=(0,l.KR)(null);function n(e){t.value=e}function a(){return t.value}function i(t){e=t}function s(){return e}return{getUid:a,setUid:n,getUser:s,setUser:i,uid:t}}));var c=n(7079),r=(n(4372),n(73),n(144));function u(e){"string"===typeof e&&r.A.create({type:"negative",message:e});try{if("object"===typeof e)for(const t in e)e[t].forEach((e=>{Array.isArray(e)?e.forEach((e=>{r.A.create({type:"negative",message:e})})):"string"===typeof e&&r.A.create({type:"negative",message:e})}))}catch(e){r.A.create({type:"negative",message:"Error"})}}var d=n(6109);const p={0:"Offline",1:"Online",2:"Start Call",3:"Incoming Call",10:"Call"},v=(0,s.nY)("videoCall",(()=>{const e=o(),t=g(),n=(0,l.KR)(0),i=(0,l.KR)(null),s=(0,l.KR)({}),c=(0,l.KR)(!1),r=(0,l.KR)(!1),v=(0,l.KR)(!1),m=(0,l.KR)(null),h=(0,a.EW)((()=>p[n.value]));function f(e){s.value=e}function k(a,l){1===n.value&&(i.value=l??(0,d.A)(),t.socket.emit("startCall",{recipientUid:a,callUid:i.value,data:e.getUser()}),s.value={uid:a},v.value=!0,n.value=2)}async function C(){try{m.value=await navigator.mediaDevices.getUserMedia({video:!0,audio:!0});const a=e.getUser();a.uid=e.getUid(),t.socket.emit("takeCall",{callUid:i.value,recipient:{socketId:s.value.socketId},user:a}),n.value=10,r.value=!0}catch(e){y("У собеседника нет доступа к камере или микрофону"),u("У вас нет доступа к камере или микрофону")}}function b(n){t.socket.emit("rejectCall",{recipient:{socketId:n.socketId},user:{uid:e.getUid()},message:"Собеседник разговаривает"}),u("Вам завонил "+n.name)}function y(n){t.socket.emit("rejectCall",{callUid:i.value,recipient:{socketId:s.value.socketId},user:{uid:e.getUid()},message:n}),U()}function S(){t.socket.emit("endCall",{callUid:i.value,recipient:{socketId:s.value.socketId,user:{uid:e.getUid()}}}),U()}function _(){t.socket.emit("stopCall",{callUid:i.value,recipient:{uid:s.value.uid},user:{uid:e.getUid()}}),U()}function U(){i.value=null,r.value=!1,c.value=!1,s.value={},n.value=1,v.value=!1,m.value?.getTracks().forEach((e=>e.stop()))}function w(){U(),n.value=0}return{statusId:n,recipient:s,callRequestFormShow:c,callDialogShow:r,isCaller:v,stream:m,myStatus:h,startCall:k,takeCall:C,lineIsBusy:b,rejectCall:y,endCall:S,stopCall:_,setStatusOnline:U,setStatusOffline:w,setRecipient:f,callUid:i}})),m=window.appConfig.socketserver??"https://"+window.location.hostname+":8443",g=(0,s.nY)("socket",(()=>{const e=(0,l.KR)(null);e.value=(0,c.io)(m);const t=v();return e.value.on("connect",(()=>{t.setStatusOnline()})),e.value.on("connect_error",(e=>{console.log("Connection failed: "+e.message)})),e.value.on("disconnect",(()=>{t.setStatusOffline()})),{socket:e}}));var h=n(5969);const f={key:0,class:"flex"},k={key:1,class:"flex q-col-gutter-sm items-center"},C="myName",b={__name:"index",setup(e){const t=g(),n=h.A,s=o(),c=(0,l.KR)(!1),r=n.has(C+"_uid")?n.getItem(C+"_uid"):(0,d.A)(),u=n.has(C)?n.getItem(C):"User "+r.substring(0,7),p=(0,l.KR)({uid:r,name:u}),v=()=>{s.setUid(p.value.uid),s.setUser(p.value),t.socket.emit("register",{name:p.value.name,uid:p.value.uid}),n.set(C,p.value.name),n.set(C+"_uid",r),c.value=!1};return(0,a.sV)((()=>{setTimeout((()=>{v()}),1500)})),(e,t)=>{const n=(0,a.g2)("q-input"),l=(0,a.g2)("q-btn");return(0,a.uX)(),(0,a.CE)("div",null,[c.value?((0,a.uX)(),(0,a.CE)("div",f,[(0,a.bF)(n,{modelValue:p.value.name,"onUpdate:modelValue":t[0]||(t[0]=e=>p.value.name=e),outlined:"",dense:"","bg-color":"white"},null,8,["modelValue"]),(0,a.bF)(l,{color:"secondary",label:"Change name","no-caps":"",dense:"",onClick:v})])):((0,a.uX)(),(0,a.CE)("div",k,[(0,a.Lk)("div",null,[(0,a.bF)(l,{icon:"settings",flat:"",onClick:t[1]||(t[1]=e=>c.value=!c.value)})]),(0,a.Lk)("div",null,(0,i.v_)(p.value?.name),1)]))])}}};var y=n(1734),S=n(8943),_=n(272),U=n.n(_);const w=b,I=w;U()(b,"components",{QInput:y.A,QBtn:S.A});n(3764);const R=(0,s.nY)("recipient",(()=>{const e=o(),t=g(),n=(0,l.KR)([]),i=(0,a.EW)((()=>n.value.filter((t=>t.uid!==e.uid))));return t.socket.on("connect",(()=>{t.socket.on("ONLINE",(e=>{n.value=e.users}))})),t.socket.on("disconnect",(()=>{n.value.splice(0)})),{recipient:i,users:n}})),q={__name:"index",props:{recipientUid:{type:[String,Number],required:!0},label:{type:String,default:"Call"}},setup(e){const t=e,n=v(),i=(0,a.EW)((()=>n.recipient.uid===t.recipientUid&&2===n.statusId)),l=(0,a.EW)((()=>2===n.statusId)),s=()=>{n.stopCall()},o=async()=>{try{n.stream=await navigator.mediaDevices.getUserMedia({video:!0,audio:!0});const e=(0,d.A)();n.startCall(t.recipientUid,e)}catch(e){u("У вас нет доступа к камере или микрофону")}};return(t,n)=>{const c=(0,a.g2)("q-btn"),r=(0,a.g2)("q-card-section"),u=(0,a.g2)("q-card"),d=(0,a.g2)("q-dialog");return(0,a.uX)(),(0,a.CE)("div",null,[(0,a.Lk)("div",{onClick:o},[(0,a.RG)(t.$slots,"default",{calling:i.value},(()=>[(0,a.bF)(c,{color:"secondary",label:e.label,"no-caps":"",loading:i.value},null,8,["label","loading"])]))]),(0,a.bF)(d,{modelValue:l.value,"onUpdate:modelValue":n[0]||(n[0]=e=>l.value=e),seamless:"",position:"bottom"},{default:(0,a.k6)((()=>[(0,a.bF)(u,null,{default:(0,a.k6)((()=>[(0,a.bF)(r,{class:"row items-center no-wrap"},{default:(0,a.k6)((()=>[(0,a.Lk)("div",null,[(0,a.bF)(c,{label:"Отменить звонок",color:"negative","no-caps":"",onClick:s})])])),_:1})])),_:1})])),_:1},8,["modelValue"])])}}};var A=n(8840),F=n(3341),E=n(222);const V=q,L=V;U()(q,"components",{QBtn:S.A,QDialog:A.A,QCard:F.A,QCardSection:E.A});const Q={class:"flex justify-center q-pa-lg q"},D={__name:"index",setup(e){const t=R();return(e,n)=>((0,a.uX)(),(0,a.CE)("div",Q,[(0,a.Lk)("div",null,[((0,a.uX)(!0),(0,a.CE)(a.FK,null,(0,a.pI)((0,l.R1)(t).recipient,(e=>((0,a.uX)(),(0,a.CE)("div",{key:e.uid,class:"q-pa-md"},[(0,a.bF)(L,{"recipient-uid":e.uid,label:"Call "+e.user.name},null,8,["recipient-uid","label"])])))),128))])]))}},O=D,T=O,j={class:"q-ml-sm"},K={__name:"Index",setup(e){const t=v(),n=()=>t.takeCall(),s=()=>t.rejectCall("Собеседник отклонил вызов");return(e,o)=>{const c=(0,a.g2)("q-avatar"),r=(0,a.g2)("q-card-section"),u=(0,a.g2)("q-btn"),d=(0,a.g2)("q-card-actions"),p=(0,a.g2)("q-card"),v=(0,a.g2)("q-dialog");return(0,a.uX)(),(0,a.Wv)(v,{modelValue:(0,l.R1)(t).callRequestFormShow,"onUpdate:modelValue":o[0]||(o[0]=e=>(0,l.R1)(t).callRequestFormShow=e),persistent:""},{default:(0,a.k6)((()=>[(0,a.bF)(p,null,{default:(0,a.k6)((()=>[(0,a.bF)(r,{class:"row items-center"},{default:(0,a.k6)((()=>[(0,a.bF)(c,{icon:"phone",color:"primary","text-color":"white"}),(0,a.Lk)("span",j,"Входящий звонок от "+(0,i.v_)((0,l.R1)(t).recipient?.data.name),1)])),_:1}),(0,a.bF)(d,{align:"right"},{default:(0,a.k6)((()=>[(0,a.bF)(u,{flat:"",label:"Отмена",color:"primary","no-caps":"",onClick:s}),(0,a.bF)(u,{flat:"",label:"Принять",color:"primary","no-caps":"",onClick:n})])),_:1})])),_:1})])),_:1},8,["modelValue"])}}};var x=n(5305),B=n(5034);const W=K,M=W;U()(K,"components",{QDialog:A.A,QCard:F.A,QCardSection:E.A,QAvatar:x.A,QCardActions:B.A,QBtn:S.A});n(6421);const X=g(),P=v(),H=window.appConfig?.iceServers??[{urls:"stun:stun.stunprotocol.org:3478"},{urls:"stun:stun.l.google.com:19302"}],N={iceServers:H};class Y{constructor(){this.localVideo=null,this.remoteVideo=null,this.localStream=null,this.peerConnection=null}async start(e){this.localVideo=document.getElementById("localVideo"),this.remoteVideo=document.getElementById("remoteVideo");try{this.localStream=P.stream,this.localVideo.srcObject=this.localStream,this.startCall(e),X.socket.on("ONLINE",this.changeUsersList.bind(this))}catch(e){this.errorHandler(e)}}changeUsersList(e){P.recipient.id&&!e.users.find((e=>e.id===P.recipient.id))&&(u("Собеседик вышел из сети"),P.endCall(),this.stop())}startCall(e){this.peerConnection=new RTCPeerConnection(N),this.peerConnection.onicecandidate=this.gotIceCandidate.bind(this),this.peerConnection.ontrack=this.gotRemoteStream.bind(this),this.peerConnection.onconnectionstatechange=this.connectionstatechange.bind(this),X.socket.on("sdp",this.sdpMessage.bind(this)),X.socket.on("ice",this.iceMessage.bind(this)),this.localStream.getTracks().forEach((e=>this.peerConnection.addTrack(e,this.localStream))),e&&this.peerConnection.createOffer().then(this.createdDescription.bind(this)).catch(this.errorHandler)}connectionstatechange(e){"disconnected"===this.peerConnection.connectionState&&(u("Соединение потяряно"),P.setStatusOnline())}iceMessage(e){e.ice?.candidate&&this.peerConnection.addIceCandidate(new RTCIceCandidate(e.ice)).catch(this.errorHandler)}sdpMessage(e){this.peerConnection.setRemoteDescription(new RTCSessionDescription(e.sdp)).then((()=>{if("offer"===e.sdp.type)return this.peerConnection.createAnswer()})).then((e=>e&&this.createdDescription(e))).catch(this.errorHandler)}gotIceCandidate(e){e.candidate&&X.socket.emit("ice",{ice:e.candidate,recipient:P.recipient})}gotRemoteStream(e){this.remoteVideo&&(this.remoteVideo.srcObject=e.streams[0])}createdDescription(e){this.peerConnection.setLocalDescription(e).then((()=>{X.socket.emit("sdp",{sdp:this.peerConnection.localDescription,recipient:P.recipient})})).catch(this.errorHandler)}stop(){X.socket.off("ONLINE",this.changeUsersList),X.socket.off("sdp",this.sdpMessage),X.socket.off("ice",this.iceMessage),this.localStream&&this.localStream.getTracks().forEach((e=>e.stop())),this.localVideo&&(this.localVideo.srcObject=null),this.remoteVideo&&(this.remoteVideo.srcObject=null),this.peerConnection&&(this.peerConnection.close(),this.peerConnection=null)}errorHandler(e){console.error("WebRTC Error:",e)}}const $=Y,G={class:"row no-wrap ellipsis q-col-gutter-sm"},z={class:"text-negative"},Z={class:"text-secondary"},J={class:"video-call-container"},ee={class:"controls"},te={__name:"index",setup(e){const t=v();let n=null,s=0;const o=(0,l.KR)(null),c=(0,l.KR)(0),r=(0,a.EW)((()=>{const e=new Date(c.value);return new Intl.DateTimeFormat("ru-RU",{timeZone:"Etc/GMT",hour:"2-digit",minute:"2-digit",second:"2-digit"}).format(e)})),u=()=>{n?.stop(),t.endCall()},d=()=>{o.value&&(clearInterval(o.value),o.value=null)};(0,a.sV)((()=>{n=new $})),(0,a.hi)((()=>{d()}));const p=()=>{d(),c.value=0,n?.stop()},m=()=>{s=Date.now()},g=()=>{t.callDialogShow&&(s=Date.now(),o.value=setInterval((()=>{c.value=Date.now()-s,n?.peerConnection&&n.peerConnection.getStats(null).then((e=>{C(e)}))}),1e3),n.start(t.isCaller))},h={bytesPrev:0,timestampPrev:0},f=(0,l.KR)({bitrate:null,fps:null}),k=(0,a.EW)((()=>[f.value.bitrate?`Bitrate: ${f.value.bitrate} kbits/sec`:"",f.value.fps?`${f.value.fps} fps`:""].filter(Boolean).join(" ")));function C(e){e.forEach((e=>{if("inbound-rtp"===e.type&&"video"===e.mediaType){const t=e.timestamp;h.timestampPrev&&(f.value.bitrate=Math.floor(8*(e.bytesReceived-h.bytesPrev)/(t-h.timestampPrev))),h.bytesPrev=e.bytesReceived,h.timestampPrev=t,f.value.fps=e.framesPerSecond}}))}return(e,n)=>{const s=(0,a.g2)("q-space"),o=(0,a.g2)("q-tooltip"),c=(0,a.g2)("q-btn"),d=(0,a.g2)("q-bar"),v=(0,a.g2)("q-card-section"),h=(0,a.g2)("q-card"),f=(0,a.g2)("q-dialog");return(0,a.uX)(),(0,a.Wv)(f,{modelValue:(0,l.R1)(t).callDialogShow,"onUpdate:modelValue":n[0]||(n[0]=e=>(0,l.R1)(t).callDialogShow=e),persistent:"","transition-duration":250,maximized:"",onHide:p,onShow:g,onBeforeShow:m},{default:(0,a.k6)((()=>[(0,a.bF)(h,null,{default:(0,a.k6)((()=>[(0,a.bF)(d,null,{default:(0,a.k6)((()=>[(0,a.Lk)("div",G,[(0,a.Lk)("div",null,(0,i.v_)((0,l.R1)(t).recipient.name),1),(0,a.Lk)("div",z,(0,i.v_)(r.value),1),(0,a.Lk)("div",Z,(0,i.v_)(k.value),1)]),(0,a.bF)(s),(0,a.bF)(c,{dense:"",flat:"",icon:"close",onClick:u},{default:(0,a.k6)((()=>[(0,a.bF)(o,null,{default:(0,a.k6)((()=>n[1]||(n[1]=[(0,a.eW)("Close")]))),_:1})])),_:1})])),_:1}),(0,a.bF)(v,{class:"q-pa-none"},{default:(0,a.k6)((()=>[(0,a.Lk)("div",J,[n[2]||(n[2]=(0,a.Lk)("div",{class:"video-wrapper"},[(0,a.Lk)("video",{id:"remoteVideo",class:"video",autoplay:"",playsinline:""}),(0,a.Lk)("div",{class:"incoming-video"},[(0,a.Lk)("video",{id:"localVideo",class:"video",autoplay:"",playsinline:""})])],-1)),(0,a.Lk)("div",ee,[(0,a.bF)(c,{label:"Отмена",color:"negative","no-caps":"",onClick:u})])])])),_:1})])),_:1})])),_:1},8,["modelValue"])}}};var ne=n(2968),ae=n(343),ie=n(5873),le=n(3948);const se=(0,ne.A)(te,[["__scopeId","data-v-97ad76b8"]]),oe=se;U()(te,"components",{QDialog:A.A,QCard:F.A,QBar:ae.A,QSpace:ie.A,QBtn:S.A,QTooltip:le.A,QCardSection:E.A});const ce={__name:"index",setup(e){const t=g(),n=v(),i={callRequest:d,rejectCall:c,takeCall:r,endCall:s,stopCall:o};function l(e){const t=document.createElement("script");t.src=e;const n=document.querySelector("script");n.parentNode.insertBefore(t,n)}function s(e){n.callUid===e.callUid&&n.statusId>1&&(u("Собеседник завершил разговор"),n.setStatusOnline())}function o(e){n.callUid===e.callUid&&n.statusId>=1&&n.setStatusOnline()}function c(e){n.callUid===e.callUid&&n.statusId>0&&(e.message&&u(e.message),n.setStatusOnline())}async function r(e){n.recipient.socketId=e.recipient.socketId,n.callDialogShow=!0,n.statusId=10}async function d(e){1===n.statusId?(n.callUid=e.callUid,n.statusId=3,n.setRecipient(e.recipient),n.callRequestFormShow=!0):n.lineIsBusy(e.data)}return(0,a.sV)((()=>{l("./js/adapter-latest.js"),Object.entries(i).forEach((([e,n])=>{t.socket.on(e,n)}))})),(0,a.hi)((()=>{Object.entries(i).forEach((([e,n])=>{t.socket.off(e,n)}))})),(e,t)=>((0,a.uX)(),(0,a.CE)("div",null,[(0,a.bF)(M),(0,a.bF)(oe)]))}},re=ce,ue=re,de={__name:"MainLayout",setup(e){return(e,t)=>{const n=(0,a.g2)("q-toolbar-title"),i=(0,a.g2)("q-toolbar"),l=(0,a.g2)("q-header"),s=(0,a.g2)("q-page-container"),o=(0,a.g2)("q-layout");return(0,a.uX)(),(0,a.Wv)(o,{view:"lHh Lpr lFf"},{default:(0,a.k6)((()=>[(0,a.bF)(l,{elevated:""},{default:(0,a.k6)((()=>[(0,a.bF)(i,null,{default:(0,a.k6)((()=>[(0,a.bF)(n,null,{default:(0,a.k6)((()=>t[0]||(t[0]=[(0,a.eW)(" Video Call ")]))),_:1}),(0,a.bF)(ue,{class:"q-mr-md"}),(0,a.bF)(I)])),_:1})])),_:1}),(0,a.bF)(s,null,{default:(0,a.k6)((()=>[(0,a.bF)(T)])),_:1})])),_:1})}}};var pe=n(6148),ve=n(6865),me=n(6739),ge=n(4629),he=n(970);const fe=de,ke=fe;U()(de,"components",{QLayout:pe.A,QHeader:ve.A,QToolbar:me.A,QToolbarTitle:ge.A,QPageContainer:he.A})}}]);