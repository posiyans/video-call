"use strict";(globalThis["webpackChunkfrontend"]=globalThis["webpackChunkfrontend"]||[]).push([[218],{2218:(e,t,n)=>{n.r(t),n.d(t,{default:()=>ke});var a=n(1347),i=n(4187),l=n(7763),s=n(5679),o=n(7079),c=(n(4372),n(73),n(144));function r(e){"string"===typeof e&&c.A.create({type:"negative",message:e});try{if("object"===typeof e)for(const t in e)e[t].forEach((e=>{Array.isArray(e)?e.forEach((e=>{c.A.create({type:"negative",message:e})})):"string"===typeof e&&c.A.create({type:"negative",message:e})}))}catch(e){c.A.create({type:"negative",message:"Error"})}}var u=n(6109);const d={0:"Offline",1:"Online",2:"Start Call",3:"Incoming Call",10:"Call"},p=(0,s.nY)("videoCall",(()=>{const e=f(),t=m(),n=(0,i.KR)(0),l=(0,i.KR)(null),s=(0,i.KR)({}),o=(0,i.KR)(!1),c=(0,i.KR)(!1),p=(0,i.KR)(!1),v=(0,i.KR)(null),h=(0,a.EW)((()=>d[n.value]));function g(e){s.value=e}function k(a,i){1===n.value&&(l.value=i??(0,u.A)(),t.socket.emit("startCall",{recipientUid:a,callUid:l.value,data:e.user}),s.value={uid:a},p.value=!0,n.value=2)}async function C(){try{v.value=await navigator.mediaDevices.getUserMedia({video:!0,audio:!0}),t.socket.emit("takeCall",{callUid:l.value,recipient:{socketId:s.value.socketId},user:e.user}),n.value=10,c.value=!0}catch(e){y("У собеседника нет доступа к камере или микрофону"),r("У вас нет доступа к камере или микрофону")}}function b(n){t.socket.emit("rejectCall",{recipient:{socketId:n.socketId},user:{id:e.user.id},message:"Собеседник разговаривает"}),r("Вам завонил "+n.name)}function y(n){t.socket.emit("rejectCall",{callUid:l.value,recipient:{socketId:s.value.socketId},user:{uid:e.getUid()},message:n}),R()}function S(){t.socket.emit("endCall",{callUid:l.value,recipient:{socketId:s.value.socketId,user:{uid:e.getUid()}}}),R()}function _(){t.socket.emit("stopCall",{callUid:l.value,recipient:{uid:s.value.uid},user:{uid:e.getUid()}}),R()}function R(){l.value=null,c.value=!1,o.value=!1,s.value={},n.value=1,p.value=!1,v.value?.getTracks().forEach((e=>e.stop()))}function w(){R(),n.value=0}return{statusId:n,recipient:s,callRequestFormShow:o,callDialogShow:c,isCaller:p,stream:v,myStatus:h,startCall:k,takeCall:C,lineIsBusy:b,rejectCall:y,endCall:S,stopCall:_,setStatusOnline:R,setStatusOffline:w,setRecipient:g,callUid:l}})),v=window.appConfig.socketserver??"https://"+window.location.hostname+":8443",m=(0,s.nY)("socket",(()=>{const e=(0,i.KR)(null);e.value=(0,o.io)(v);const t=p();return e.value.on("connect",(()=>{t.setStatusOnline()})),e.value.on("connect_error",(e=>{console.log("Connection failed: "+e.message)})),e.value.on("disconnect",(()=>{t.setStatusOffline()})),{socket:e}}));var h=n(5969);const g=h.A,f=(0,s.nY)("user",(()=>{const e=m(),t="myName",n=g.has(t+"_uid")?g.getItem(t+"_uid"):(0,u.A)(),a=g.has(t)?g.getItem(t):"User "+n.substring(0,7),l=(0,i.KR)({uid:n,name:a}),s=()=>{e.socket.emit("register",l.value),g.set(t,l.value.name),g.set(t+"_uid",n)};function o(){return l.value.uid}return{user:l,login:s,getUid:o}})),k={key:0,class:"flex"},C={key:1,class:"flex q-col-gutter-sm items-center"},b={__name:"index",setup(e){const t=f(),n=(0,i.KR)(!1),s=()=>{t.login(),n.value=!1};return(0,a.sV)((()=>{setTimeout((()=>{s()}),1500)})),(e,o)=>{const c=(0,a.g2)("q-input"),r=(0,a.g2)("q-btn");return(0,a.uX)(),(0,a.CE)("div",null,[n.value?((0,a.uX)(),(0,a.CE)("div",k,[(0,a.bF)(c,{modelValue:(0,i.R1)(t).user.name,"onUpdate:modelValue":o[0]||(o[0]=e=>(0,i.R1)(t).user.name=e),outlined:"",dense:"","bg-color":"white"},null,8,["modelValue"]),(0,a.bF)(r,{color:"secondary",label:"Change name","no-caps":"",dense:"",onClick:s})])):((0,a.uX)(),(0,a.CE)("div",C,[(0,a.Lk)("div",null,[(0,a.bF)(r,{icon:"settings",flat:"",onClick:o[1]||(o[1]=e=>n.value=!n.value)})]),(0,a.Lk)("div",null,(0,l.v_)((0,i.R1)(t).user?.name),1)]))])}}};var y=n(1734),S=n(8943),_=n(272),R=n.n(_);const w=b,I=w;R()(b,"components",{QInput:y.A,QBtn:S.A});n(3764);const q=(0,s.nY)("recipient",(()=>{const e=f(),t=m(),n=(0,i.KR)([]),l=(0,a.EW)((()=>n.value.filter((t=>t.uid!==e.user.uid))));return t.socket.on("connect",(()=>{t.socket.on("ONLINE",(e=>{n.value=e.users}))})),t.socket.on("disconnect",(()=>{n.value.splice(0)})),{recipient:l,users:n}})),A={__name:"index",props:{recipientUid:{type:[String,Number],required:!0},label:{type:String,default:"Call"}},setup(e){const t=e,n=p(),i=(0,a.EW)((()=>n.recipient.uid===t.recipientUid&&2===n.statusId)),l=(0,a.EW)((()=>2===n.statusId)),s=()=>{n.stopCall()},o=async()=>{try{n.stream=await navigator.mediaDevices.getUserMedia({video:!0,audio:!0});const e=(0,u.A)();n.startCall(t.recipientUid,e)}catch(e){r("У вас нет доступа к камере или микрофону")}};return(t,n)=>{const c=(0,a.g2)("q-btn"),r=(0,a.g2)("q-card-section"),u=(0,a.g2)("q-card"),d=(0,a.g2)("q-dialog");return(0,a.uX)(),(0,a.CE)("div",null,[(0,a.bF)(c,{color:"secondary",label:e.label,"no-caps":"",loading:i.value,onClick:o},null,8,["label","loading"]),(0,a.bF)(d,{modelValue:l.value,"onUpdate:modelValue":n[0]||(n[0]=e=>l.value=e),seamless:"",position:"bottom"},{default:(0,a.k6)((()=>[(0,a.bF)(u,null,{default:(0,a.k6)((()=>[(0,a.bF)(r,{class:"row items-center no-wrap"},{default:(0,a.k6)((()=>[(0,a.Lk)("div",null,[(0,a.bF)(c,{label:"Отменить звонок",color:"negative","no-caps":"",onClick:s})])])),_:1})])),_:1})])),_:1},8,["modelValue"])])}}};var F=n(8840),U=n(3341),E=n(222);const V=A,L=V;R()(A,"components",{QBtn:S.A,QDialog:F.A,QCard:U.A,QCardSection:E.A});const Q={class:"flex justify-center q-pa-lg q"},D={__name:"index",setup(e){const t=q();return(e,n)=>((0,a.uX)(),(0,a.CE)("div",Q,[(0,a.Lk)("div",null,[((0,a.uX)(!0),(0,a.CE)(a.FK,null,(0,a.pI)((0,i.R1)(t).recipient,(e=>((0,a.uX)(),(0,a.CE)("div",{key:e.uid,class:"q-pa-md"},[(0,a.bF)(L,{"recipient-uid":e.uid,label:"Call "+e.user.name},null,8,["recipient-uid","label"])])))),128))])]))}},O=D,T=O,j={class:"q-ml-sm"},K={__name:"Index",setup(e){const t=p(),n=()=>t.takeCall(),s=()=>t.rejectCall("Собеседник отклонил вызов");return(e,o)=>{const c=(0,a.g2)("q-avatar"),r=(0,a.g2)("q-card-section"),u=(0,a.g2)("q-btn"),d=(0,a.g2)("q-card-actions"),p=(0,a.g2)("q-card"),v=(0,a.g2)("q-dialog");return(0,a.uX)(),(0,a.Wv)(v,{modelValue:(0,i.R1)(t).callRequestFormShow,"onUpdate:modelValue":o[0]||(o[0]=e=>(0,i.R1)(t).callRequestFormShow=e),persistent:""},{default:(0,a.k6)((()=>[(0,a.bF)(p,null,{default:(0,a.k6)((()=>[(0,a.bF)(r,{class:"row items-center"},{default:(0,a.k6)((()=>[(0,a.bF)(c,{icon:"phone",color:"primary","text-color":"white"}),(0,a.Lk)("span",j,"Входящий звонок от "+(0,l.v_)((0,i.R1)(t).recipient?.data.name),1)])),_:1}),(0,a.bF)(d,{align:"right"},{default:(0,a.k6)((()=>[(0,a.bF)(u,{flat:"",label:"Отмена",color:"primary","no-caps":"",onClick:s}),(0,a.bF)(u,{flat:"",label:"Принять",color:"primary","no-caps":"",onClick:n})])),_:1})])),_:1})])),_:1},8,["modelValue"])}}};var x=n(5305),B=n(5034);const W=K,M=W;R()(K,"components",{QDialog:F.A,QCard:U.A,QCardSection:E.A,QAvatar:x.A,QCardActions:B.A,QBtn:S.A});n(6421);const X=m(),P=p(),H=window.appConfig?.iceServers??[{urls:"stun:stun.stunprotocol.org:3478"},{urls:"stun:stun.l.google.com:19302"}],N={iceServers:H};class Y{constructor(){this.localVideo=null,this.remoteVideo=null,this.localStream=null,this.peerConnection=null}async start(e){this.localVideo=document.getElementById("localVideo"),this.remoteVideo=document.getElementById("remoteVideo");try{this.localStream=P.stream,this.localVideo.srcObject=this.localStream,this.startCall(e),X.socket.on("ONLINE",this.changeUsersList.bind(this))}catch(e){this.errorHandler(e)}}changeUsersList(e){P.recipient.id&&!e.users.find((e=>e.id===P.recipient.id))&&(r("Собеседик вышел из сети"),P.endCall(),this.stop())}startCall(e){this.peerConnection=new RTCPeerConnection(N),this.peerConnection.onicecandidate=this.gotIceCandidate.bind(this),this.peerConnection.ontrack=this.gotRemoteStream.bind(this),this.peerConnection.onconnectionstatechange=this.connectionstatechange.bind(this),X.socket.on("sdp",this.sdpMessage.bind(this)),X.socket.on("ice",this.iceMessage.bind(this)),this.localStream.getTracks().forEach((e=>this.peerConnection.addTrack(e,this.localStream))),e&&this.peerConnection.createOffer().then(this.createdDescription.bind(this)).catch(this.errorHandler)}connectionstatechange(e){"disconnected"===this.peerConnection.connectionState&&(r("Соединение потяряно"),P.setStatusOnline())}iceMessage(e){e.ice?.candidate&&this.peerConnection.addIceCandidate(new RTCIceCandidate(e.ice)).catch(this.errorHandler)}sdpMessage(e){this.peerConnection.setRemoteDescription(new RTCSessionDescription(e.sdp)).then((()=>{if("offer"===e.sdp.type)return this.peerConnection.createAnswer()})).then((e=>e&&this.createdDescription(e))).catch(this.errorHandler)}gotIceCandidate(e){e.candidate&&X.socket.emit("ice",{ice:e.candidate,recipient:P.recipient})}gotRemoteStream(e){this.remoteVideo&&(this.remoteVideo.srcObject=e.streams[0])}createdDescription(e){this.peerConnection.setLocalDescription(e).then((()=>{X.socket.emit("sdp",{sdp:this.peerConnection.localDescription,recipient:P.recipient})})).catch(this.errorHandler)}stop(){X.socket.off("ONLINE",this.changeUsersList),X.socket.off("sdp",this.sdpMessage),X.socket.off("ice",this.iceMessage),this.localStream&&this.localStream.getTracks().forEach((e=>e.stop())),this.localVideo&&(this.localVideo.srcObject=null),this.remoteVideo&&(this.remoteVideo.srcObject=null),this.peerConnection&&(this.peerConnection.close(),this.peerConnection=null)}errorHandler(e){console.error("WebRTC Error:",e)}}const $=Y,z={class:"row no-wrap ellipsis q-col-gutter-sm"},G={class:"text-negative"},Z={class:"text-secondary"},J={class:"video-call-container"},ee={class:"controls"},te={__name:"index",setup(e){const t=p();let n=null,s=0;const o=(0,i.KR)(null),c=(0,i.KR)(0),r=(0,a.EW)((()=>{const e=new Date(c.value);return new Intl.DateTimeFormat("ru-RU",{timeZone:"Etc/GMT",hour:"2-digit",minute:"2-digit",second:"2-digit"}).format(e)})),u=()=>{n?.stop(),t.endCall()},d=()=>{o.value&&(clearInterval(o.value),o.value=null)};(0,a.sV)((()=>{n=new $})),(0,a.hi)((()=>{d()}));const v=()=>{d(),c.value=0,n?.stop()},m=()=>{s=Date.now()},h=()=>{t.callDialogShow&&(s=Date.now(),o.value=setInterval((()=>{c.value=Date.now()-s,n?.peerConnection&&n.peerConnection.getStats(null).then((e=>{C(e)}))}),1e3),n.start(t.isCaller))},g={bytesPrev:0,timestampPrev:0},f=(0,i.KR)({bitrate:null,fps:null}),k=(0,a.EW)((()=>[f.value.bitrate?`Bitrate: ${f.value.bitrate} kbits/sec`:"",f.value.fps?`${f.value.fps} fps`:""].filter(Boolean).join(" ")));function C(e){e.forEach((e=>{if("inbound-rtp"===e.type&&"video"===e.mediaType){const t=e.timestamp;g.timestampPrev&&(f.value.bitrate=Math.floor(8*(e.bytesReceived-g.bytesPrev)/(t-g.timestampPrev))),g.bytesPrev=e.bytesReceived,g.timestampPrev=t,f.value.fps=e.framesPerSecond}}))}return(e,n)=>{const s=(0,a.g2)("q-space"),o=(0,a.g2)("q-tooltip"),c=(0,a.g2)("q-btn"),d=(0,a.g2)("q-bar"),p=(0,a.g2)("q-card-section"),g=(0,a.g2)("q-card"),f=(0,a.g2)("q-dialog");return(0,a.uX)(),(0,a.Wv)(f,{modelValue:(0,i.R1)(t).callDialogShow,"onUpdate:modelValue":n[0]||(n[0]=e=>(0,i.R1)(t).callDialogShow=e),persistent:"","transition-duration":250,maximized:"",onHide:v,onShow:h,onBeforeShow:m},{default:(0,a.k6)((()=>[(0,a.bF)(g,null,{default:(0,a.k6)((()=>[(0,a.bF)(d,null,{default:(0,a.k6)((()=>[(0,a.Lk)("div",z,[(0,a.Lk)("div",null,(0,l.v_)((0,i.R1)(t).recipient.name),1),(0,a.Lk)("div",G,(0,l.v_)(r.value),1),(0,a.Lk)("div",Z,(0,l.v_)(k.value),1)]),(0,a.bF)(s),(0,a.bF)(c,{dense:"",flat:"",icon:"close",onClick:u},{default:(0,a.k6)((()=>[(0,a.bF)(o,null,{default:(0,a.k6)((()=>n[1]||(n[1]=[(0,a.eW)("Close")]))),_:1})])),_:1})])),_:1}),(0,a.bF)(p,{class:"q-pa-none"},{default:(0,a.k6)((()=>[(0,a.Lk)("div",J,[n[2]||(n[2]=(0,a.Lk)("div",{class:"video-wrapper"},[(0,a.Lk)("video",{id:"remoteVideo",class:"video",autoplay:"",playsinline:""}),(0,a.Lk)("div",{class:"incoming-video"},[(0,a.Lk)("video",{id:"localVideo",class:"video",autoplay:"",playsinline:""})])],-1)),(0,a.Lk)("div",ee,[(0,a.bF)(c,{label:"Отмена",color:"negative","no-caps":"",onClick:u})])])])),_:1})])),_:1})])),_:1},8,["modelValue"])}}};var ne=n(2968),ae=n(343),ie=n(5873),le=n(3948);const se=(0,ne.A)(te,[["__scopeId","data-v-107d89b9"]]),oe=se;R()(te,"components",{QDialog:F.A,QCard:U.A,QBar:ae.A,QSpace:ie.A,QBtn:S.A,QTooltip:le.A,QCardSection:E.A});const ce={__name:"index",setup(e){const t=m(),n=p(),i={callRequest:d,rejectCall:c,takeCall:u,endCall:s,stopCall:o};function l(e){var t=document.createElement("script");t.src=e;var n=document.querySelector("script");n.parentNode.insertBefore(t,n)}function s(e){n.callUid===e.callUid&&n.statusId>1&&(r("Собеседник завершил разговор"),n.setStatusOnline())}function o(e){n.callUid===e.callUid&&n.statusId>=1&&n.setStatusOnline()}function c(e){n.callUid===e.callUid&&n.statusId>0&&(e.message&&r(e.message),n.setStatusOnline())}async function u(e){n.recipient.socketId=e.recipient.socketId,n.callDialogShow=!0,n.statusId=10}async function d(e){1===n.statusId?(n.callUid=e.callUid,n.statusId=3,n.setRecipient(e.recipient),n.callRequestFormShow=!0):n.lineIsBusy(e.data)}return(0,a.sV)((()=>{l("./js/adapter-latest.js"),Object.entries(i).forEach((([e,n])=>{t.socket.on(e,n)}))})),(0,a.hi)((()=>{Object.entries(i).forEach((([e,n])=>{t.socket.off(e,n)}))})),(e,t)=>((0,a.uX)(),(0,a.CE)("div",null,[(0,a.bF)(M),(0,a.bF)(oe)]))}},re=ce,ue=re,de={__name:"MainLayout",setup(e){return(e,t)=>{const n=(0,a.g2)("q-toolbar-title"),i=(0,a.g2)("q-toolbar"),l=(0,a.g2)("q-header"),s=(0,a.g2)("q-page-container"),o=(0,a.g2)("q-layout");return(0,a.uX)(),(0,a.Wv)(o,{view:"lHh Lpr lFf"},{default:(0,a.k6)((()=>[(0,a.bF)(l,{elevated:""},{default:(0,a.k6)((()=>[(0,a.bF)(i,null,{default:(0,a.k6)((()=>[(0,a.bF)(n,null,{default:(0,a.k6)((()=>t[0]||(t[0]=[(0,a.eW)(" Video Call ")]))),_:1}),(0,a.bF)(ue,{class:"q-mr-md"}),(0,a.bF)(I)])),_:1})])),_:1}),(0,a.bF)(s,null,{default:(0,a.k6)((()=>[(0,a.bF)(T)])),_:1})])),_:1})}}};var pe=n(6148),ve=n(6865),me=n(6739),he=n(4629),ge=n(970);const fe=de,ke=fe;R()(de,"components",{QLayout:pe.A,QHeader:ve.A,QToolbar:me.A,QToolbarTitle:he.A,QPageContainer:ge.A})}}]);