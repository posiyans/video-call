"use strict";(globalThis["webpackChunkfrontend"]=globalThis["webpackChunkfrontend"]||[]).push([[911],{1911:(e,t,n)=>{n.r(t),n.d(t,{default:()=>ke});var a=n(1347),i=n(4187),s=n(7763),o=n(5679),l=n(7079),r=(n(4372),n(73),n(144));function c(e){"string"===typeof e&&r.A.create({type:"negative",message:e});try{if("object"===typeof e)for(const t in e)e[t].forEach((e=>{Array.isArray(e)?e.forEach((e=>{r.A.create({type:"negative",message:e})})):"string"===typeof e&&r.A.create({type:"negative",message:e})}))}catch(e){r.A.create({type:"negative",message:"Error"})}}const d={0:"Offline",1:"Online",2:"Start Call",3:"Incoming Call",10:"Call"},u=(0,o.nY)("videoCall",(()=>{const e=g(),t=v(),n=(0,i.KR)(0),s=(0,i.KR)({}),o=(0,i.KR)(!1),l=(0,i.KR)(!1),r=(0,i.KR)(!1),u=(0,i.KR)(null),p=(0,a.EW)((()=>d[n.value]));function m(e){s.value=e}function h(a){1===n.value&&(t.socket.emit("startCall",{recipientId:a,user:e.user}),s.value={id:a},r.value=!0,n.value=2)}async function f(){try{u.value=await navigator.mediaDevices.getUserMedia({video:!0,audio:!0}),t.socket.emit("takeCall",{recipient:{socketId:s.value.socketId},user:e.user}),n.value=10,l.value=!0}catch(e){C("У собеседника нет доступа к камере или микрофону"),c("У вас нет доступа к камере или микрофону")}}function k(n){t.socket.emit("rejectCall",{recipient:{socketId:n.socketId},user:{id:e.user.id},message:"Собеседник разговаривает"}),c("Вам завонил "+n.name)}function C(n){t.socket.emit("rejectCall",{recipient:{socketId:s.value.socketId},user:{id:e.user.id},message:n}),I()}function b(){t.socket.emit("endCall",{recipient:{socketId:s.value.socketId,user:{id:e.user.id}}}),I()}function y(){t.socket.emit("stopCall",{recipient:{id:s.value.id},user:{id:e.user.id}}),I()}function I(){l.value=!1,o.value=!1,s.value={},n.value=1,r.value=!1,u.value?.getTracks().forEach((e=>e.stop()))}function w(){l.value=!1,o.value=!1,s.value={},n.value=0}return{statusId:n,recipient:s,callRequestFormShow:o,callDialogShow:l,isCaller:r,stream:u,myStatus:p,startCall:h,takeCall:f,lineIsBusy:k,rejectCall:C,endCall:b,stopCall:y,setStatusOnline:I,setStatusOffline:w,setRecipient:m}}));n(3764);const p=(0,o.nY)("recipient",(()=>{const e=g(),t=(0,i.KR)([]),n=(0,a.EW)((()=>t.value.filter((t=>t.id!==e.user.id))));return{recipient:n,users:t}})),m=window.appConfig.socketserver??"https://"+window.location.hostname+":8443",v=(0,o.nY)("socket",(()=>{const e=(0,i.KR)(null);e.value=(0,l.io)(m);const t=u(),n=p();return e.value.on("connect",(()=>{t.setStatusOnline(),e.value.on("ONLINE",(e=>{n.users=e.users}))})),e.value.on("connect_error",(e=>{console.log("Connection failed: "+e.message)})),e.value.on("disconnect",(()=>{t.setStatusOffline(),n.users.splice(0)})),{socket:e}}));var h=n(3328);const g=(0,o.nY)("user",(()=>{const e=v(),t=Math.floor(1e4*Math.random()),n="myName",a=h.A.has(n)?h.A.getItem(n):"User "+t,s=(0,i.KR)({id:t,name:a}),o=()=>{e.socket.emit("register",s.value),h.A.set(n,s.value.name)};return{user:s,login:o}})),f={key:0,class:"flex"},k={key:1,class:"flex q-col-gutter-sm items-center"},C={__name:"index",setup(e){const t=g(),n=(0,i.KR)(!1),o=()=>{t.login(),n.value=!1};return(0,a.sV)((()=>{setTimeout((()=>{o()}),1500)})),(e,l)=>{const r=(0,a.g2)("q-input"),c=(0,a.g2)("q-btn");return n.value?((0,a.uX)(),(0,a.CE)("div",f,[(0,a.bF)(r,{modelValue:(0,i.R1)(t).user.name,"onUpdate:modelValue":l[0]||(l[0]=e=>(0,i.R1)(t).user.name=e),outlined:"",dense:"","bg-color":"white"},null,8,["modelValue"]),(0,a.bF)(c,{color:"secondary",label:"Change name",onClick:o,"no-caps":"",dense:""})])):((0,a.uX)(),(0,a.CE)("div",k,[(0,a.Lk)("div",null,[(0,a.bF)(c,{icon:"settings",flat:"",onClick:l[1]||(l[1]=e=>n.value=!n.value)})]),(0,a.Lk)("div",null,(0,s.v_)((0,i.R1)(t).user?.name),1)]))}}};var b=n(2099),y=n(8943),I=n(272),w=n.n(I);const R=C,S=R;w()(C,"components",{QInput:b.A,QBtn:y.A});const q={key:0},_={__name:"index",props:{recipientId:{type:[String,Number],required:!0},label:{type:String,default:"Call"}},setup(e){const t=e,n=g(),s=u(),o=(0,a.EW)((()=>s.recipient.id===t.recipientId&&2===s.statusId)),l=(0,a.EW)((()=>2===s.statusId)),r=()=>{s.stopCall()},d=async()=>{try{s.stream=await navigator.mediaDevices.getUserMedia({video:!0,audio:!0}),s.startCall(t.recipientId)}catch(e){c("У вас нет доступа к камере или микрофону")}};return(t,s)=>{const c=(0,a.g2)("q-btn"),u=(0,a.g2)("q-card-section"),p=(0,a.g2)("q-card"),m=(0,a.g2)("q-dialog");return(0,i.R1)(n).user.id?((0,a.uX)(),(0,a.CE)("div",q,[(0,a.bF)(c,{color:"secondary",label:e.label,onClick:d,"no-caps":"",loading:o.value},null,8,["label","loading"]),(0,a.bF)(m,{modelValue:l.value,"onUpdate:modelValue":s[0]||(s[0]=e=>l.value=e),seamless:"",position:"bottom"},{default:(0,a.k6)((()=>[(0,a.bF)(p,null,{default:(0,a.k6)((()=>[(0,a.bF)(u,{class:"row items-center no-wrap"},{default:(0,a.k6)((()=>[(0,a.Lk)("div",null,[(0,a.bF)(c,{label:"Отменить звонок",color:"negative","no-caps":"",onClick:r})])])),_:1})])),_:1})])),_:1},8,["modelValue"])])):(0,a.Q3)("",!0)}}};var F=n(8840),A=n(3341),V=n(222);const E=_,L=E;w()(_,"components",{QBtn:y.A,QDialog:F.A,QCard:A.A,QCardSection:V.A});const Q={class:"flex justify-center q-pa-lg q"},D={__name:"index",setup(e){const t=p();return(e,n)=>((0,a.uX)(),(0,a.CE)("div",Q,[(0,a.Lk)("div",null,[((0,a.uX)(!0),(0,a.CE)(a.FK,null,(0,a.pI)((0,i.R1)(t).recipient,(e=>((0,a.uX)(),(0,a.CE)("div",{key:e.id,class:"q-pa-md"},[(0,a.bF)(L,{"recipient-id":e.id,label:"Call "+e.name},null,8,["recipient-id","label"])])))),128))])]))}},T=D,O=T,j={class:"q-ml-sm"},K={__name:"Index",setup(e){const t=u(),n=()=>{setTimeout((()=>{o()}),500)},o=()=>t.takeCall(),l=()=>t.rejectCall("Собеседник отклонил вызов");return(e,r)=>{const c=(0,a.g2)("q-avatar"),d=(0,a.g2)("q-card-section"),u=(0,a.g2)("q-btn"),p=(0,a.g2)("q-card-actions"),m=(0,a.g2)("q-card"),v=(0,a.g2)("q-dialog"),h=(0,a.gN)("close-popup");return(0,a.uX)(),(0,a.Wv)(v,{modelValue:(0,i.R1)(t).callRequestFormShow,"onUpdate:modelValue":r[0]||(r[0]=e=>(0,i.R1)(t).callRequestFormShow=e),persistent:"",onShow:n},{default:(0,a.k6)((()=>[(0,a.bF)(m,null,{default:(0,a.k6)((()=>[(0,a.bF)(d,{class:"row items-center"},{default:(0,a.k6)((()=>[(0,a.bF)(c,{icon:"phone",color:"primary","text-color":"white"}),(0,a.Lk)("span",j,"Входящий звонок от "+(0,s.v_)((0,i.R1)(t).recipient?.name),1)])),_:1}),(0,a.bF)(p,{align:"right"},{default:(0,a.k6)((()=>[(0,a.bo)((0,a.bF)(u,{flat:"",label:"Отмена",color:"primary",onClick:l,"no-caps":""},null,512),[[h]]),(0,a.bo)((0,a.bF)(u,{flat:"",label:"Принять",color:"primary",onClick:o,"no-caps":""},null,512),[[h]])])),_:1})])),_:1})])),_:1},8,["modelValue"])}}};var x=n(5305),B=n(5034),M=n(8657);const W=K,P=W;w()(K,"components",{QDialog:F.A,QCard:A.A,QCardSection:V.A,QAvatar:x.A,QCardActions:B.A,QBtn:y.A}),w()(K,"directives",{ClosePopup:M.A});n(6421);const U=v(),N=u(),X=window.appConfig?.iceServers??[{urls:"stun:stun.stunprotocol.org:3478"},{urls:"stun:stun.l.google.com:19302"}],H={iceServers:X};class Y{constructor(){this.localVideo=null,this.remoteVideo=null,this.localStream=null,this.peerConnection=null}async start(e){this.localVideo=document.getElementById("localVideo"),this.remoteVideo=document.getElementById("remoteVideo");try{this.localStream=N.stream,this.localVideo.srcObject=this.localStream,this.startCall(e),U.socket.on("ONLINE",this.changeUsersList.bind(this))}catch(e){this.errorHandler(e)}}changeUsersList(e){N.recipient.id&&!e.users.find((e=>e.id===N.recipient.id))&&(c("Собеседик вышел из сети"),N.endCall(),this.stop())}startCall(e){this.peerConnection=new RTCPeerConnection(H),this.peerConnection.onicecandidate=this.gotIceCandidate.bind(this),this.peerConnection.ontrack=this.gotRemoteStream.bind(this),U.socket.on("sdp",this.sdpMessage.bind(this)),U.socket.on("ice",this.iceMessage.bind(this)),this.localStream.getTracks().forEach((e=>this.peerConnection.addTrack(e,this.localStream))),e&&this.peerConnection.createOffer().then(this.createdDescription.bind(this)).catch(this.errorHandler)}iceMessage(e){e.ice?.candidate&&this.peerConnection.addIceCandidate(new RTCIceCandidate(e.ice)).catch(this.errorHandler)}sdpMessage(e){this.peerConnection.setRemoteDescription(new RTCSessionDescription(e.sdp)).then((()=>{if("offer"===e.sdp.type)return this.peerConnection.createAnswer()})).then((e=>e&&this.createdDescription(e))).catch(this.errorHandler)}gotIceCandidate(e){e.candidate&&U.socket.emit("ice",{ice:e.candidate,recipient:N.recipient})}gotRemoteStream(e){this.remoteVideo&&(this.remoteVideo.srcObject=e.streams[0])}createdDescription(e){this.peerConnection.setLocalDescription(e).then((()=>{U.socket.emit("sdp",{sdp:this.peerConnection.localDescription,recipient:N.recipient})})).catch(this.errorHandler)}stop(){U.socket.off("ONLINE",this.changeUsersList),U.socket.off("sdp",this.sdpMessage),U.socket.off("ice",this.iceMessage),this.localStream&&this.localStream.getTracks().forEach((e=>e.stop())),this.localVideo&&(this.localVideo.srcObject=null),this.remoteVideo&&(this.remoteVideo.srcObject=null),this.peerConnection&&(this.peerConnection.close(),this.peerConnection=null)}errorHandler(e){console.error("WebRTC Error:",e)}}const $=Y,z={class:"row no-wrap ellipsis q-col-gutter-sm"},G={class:"text-negative"},Z={class:"text-secondary"},J={class:"video-call-container"},ee={class:"controls"},te={__name:"index",setup(e){const t=u();let n=null,o=0;const l=(0,i.KR)(null),r=(0,i.KR)(0),c=(0,a.EW)((()=>{const e=new Date(r.value);return new Intl.DateTimeFormat("ru-RU",{timeZone:"Etc/GMT",hour:"2-digit",minute:"2-digit",second:"2-digit"}).format(e)})),d=()=>{n?.stop(),t.endCall()},p=()=>{l.value&&(clearInterval(l.value),l.value=null)};(0,a.sV)((()=>{n=new $})),(0,a.hi)((()=>{p()}));const m=()=>{p(),r.value=0,n?.stop()},v=()=>{o=Date.now()},h=()=>{t.callDialogShow&&(o=Date.now(),l.value=setInterval((()=>{r.value=Date.now()-o,n?.peerConnection&&n.peerConnection.getStats(null).then((e=>{C(e)}))}),1e3),n.start(t.isCaller))},g={bytesPrev:0,timestampPrev:0},f=(0,i.KR)({bitrate:null,fps:null}),k=(0,a.EW)((()=>[f.value.bitrate?`Bitrate: ${f.value.bitrate} kbits/sec`:"",f.value.fps?`${f.value.fps} fps`:""].filter(Boolean).join(" ")));function C(e){e.forEach((e=>{if("inbound-rtp"===e.type&&"video"===e.mediaType){const t=e.timestamp;g.timestampPrev&&(f.value.bitrate=Math.floor(8*(e.bytesReceived-g.bytesPrev)/(t-g.timestampPrev))),g.bytesPrev=e.bytesReceived,g.timestampPrev=t,f.value.fps=e.framesPerSecond}}))}return(e,n)=>{const o=(0,a.g2)("q-space"),l=(0,a.g2)("q-tooltip"),r=(0,a.g2)("q-btn"),u=(0,a.g2)("q-bar"),p=(0,a.g2)("q-card-section"),g=(0,a.g2)("q-card"),f=(0,a.g2)("q-dialog");return(0,a.uX)(),(0,a.Wv)(f,{modelValue:(0,i.R1)(t).callDialogShow,"onUpdate:modelValue":n[0]||(n[0]=e=>(0,i.R1)(t).callDialogShow=e),persistent:"","transition-duration":250,maximized:"",onHide:m,onShow:h,onBeforeShow:v},{default:(0,a.k6)((()=>[(0,a.bF)(g,null,{default:(0,a.k6)((()=>[(0,a.bF)(u,null,{default:(0,a.k6)((()=>[(0,a.Lk)("div",z,[(0,a.Lk)("div",null,(0,s.v_)((0,i.R1)(t).recipient.name),1),(0,a.Lk)("div",G,(0,s.v_)(c.value),1),(0,a.Lk)("div",Z,(0,s.v_)(k.value),1)]),(0,a.bF)(o),(0,a.bF)(r,{dense:"",flat:"",icon:"close",onClick:d},{default:(0,a.k6)((()=>[(0,a.bF)(l,null,{default:(0,a.k6)((()=>n[1]||(n[1]=[(0,a.eW)("Close")]))),_:1})])),_:1})])),_:1}),(0,a.bF)(p,{class:"q-pa-none"},{default:(0,a.k6)((()=>[(0,a.Lk)("div",J,[n[2]||(n[2]=(0,a.Lk)("div",{class:"video-wrapper"},[(0,a.Lk)("video",{id:"remoteVideo",class:"video",autoplay:"",playsinline:""}),(0,a.Lk)("div",{class:"incoming-video"},[(0,a.Lk)("video",{id:"localVideo",class:"video",autoplay:"",playsinline:""})])],-1)),(0,a.Lk)("div",ee,[(0,a.bF)(r,{label:"Отмена",color:"negative","no-caps":"",onClick:d})])])])),_:1})])),_:1})])),_:1},8,["modelValue"])}}};var ne=n(2968),ae=n(343),ie=n(5873),se=n(3948);const oe=(0,ne.A)(te,[["__scopeId","data-v-eb81016e"]]),le=oe;w()(te,"components",{QDialog:F.A,QCard:A.A,QBar:ae.A,QSpace:ie.A,QBtn:y.A,QTooltip:se.A,QCardSection:V.A});const re={__name:"index",setup(e){const t=v(),n=u(),i={callRequest:p,rejectCall:r,takeCall:d,endCall:o,stopCall:l};function s(e){var t=document.createElement("script");t.src=e;var n=document.querySelector("script");n.parentNode.insertBefore(t,n)}function o(e){n.recipient?.id===e.recipient.id&&n.statusId>1&&(c("Собеседник завершил разговор"),n.setStatusOnline())}function l(e){n.recipient?.id===e.recipient.id&&n.statusId>=1&&(n.callRequestFormShow=!1,n.statusId=1)}function r(e){e.message&&c(e.message),n.recipient?.id===e.recipient.id&&n.statusId>0&&n.setStatusOnline()}async function d(e){n.recipient.socketId=e.recipient.socketId,n.recipient.name=e.recipient.name,n.callDialogShow=!0,n.statusId=10}async function p(e){1===n.statusId?(n.statusId=3,n.setRecipient(e.recipient),n.callRequestFormShow=!0):n.lineIsBusy(e.recipient)}return(0,a.sV)((()=>{s("./js/adapter-latest.js"),Object.entries(i).forEach((([e,n])=>{t.socket.on(e,n)}))})),(0,a.hi)((()=>{Object.entries(i).forEach((([e,n])=>{t.socket.off(e,n)}))})),(e,t)=>((0,a.uX)(),(0,a.CE)("div",null,[(0,a.bF)(P),(0,a.bF)(le)]))}},ce=re,de=ce,ue={__name:"MainLayout",setup(e){return(e,t)=>{const n=(0,a.g2)("q-toolbar-title"),i=(0,a.g2)("q-toolbar"),s=(0,a.g2)("q-header"),o=(0,a.g2)("q-page-container"),l=(0,a.g2)("q-layout");return(0,a.uX)(),(0,a.Wv)(l,{view:"lHh Lpr lFf"},{default:(0,a.k6)((()=>[(0,a.bF)(s,{elevated:""},{default:(0,a.k6)((()=>[(0,a.bF)(i,null,{default:(0,a.k6)((()=>[(0,a.bF)(n,null,{default:(0,a.k6)((()=>t[0]||(t[0]=[(0,a.eW)(" Video Call ")]))),_:1}),(0,a.bF)(de,{class:"q-mr-md"}),(0,a.bF)(S)])),_:1})])),_:1}),(0,a.bF)(o,null,{default:(0,a.k6)((()=>[(0,a.bF)(O)])),_:1})])),_:1})}}};var pe=n(6148),me=n(6865),ve=n(6739),he=n(4629),ge=n(970);const fe=ue,ke=fe;w()(ue,"components",{QLayout:pe.A,QHeader:me.A,QToolbar:ve.A,QToolbarTitle:he.A,QPageContainer:ge.A})}}]);